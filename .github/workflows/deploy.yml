name: Deploy to Self-Hosted Windows

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "24"
          cache: "npm"

      - name: Install dependencies
        run: npm ci --legacy-peer-deps
        shell: powershell

      - name: Build application
        run: npm run build
        shell: powershell

      - name: Stop existing countdown app
        run: |
          # Stop existing scheduled task
          Stop-ScheduledTask -TaskName "CountdownApp" -ErrorAction SilentlyContinue
          Unregister-ScheduledTask -TaskName "CountdownApp" -Confirm:$false -ErrorAction SilentlyContinue

          # Kill any existing node processes running server.js
          Get-Process -Name "node" -ErrorAction SilentlyContinue | Where-Object {$_.MainWindowTitle -like "*server.js*" -or $_.CommandLine -like "*server.js*"} | Stop-Process -Force -ErrorAction SilentlyContinue

          Write-Host "Stopped existing countdown app processes"
        shell: powershell
        continue-on-error: true

      - name: Start countdown app via Task Scheduler
        run: |
          $taskName = "CountdownApp"
          $workingDir = (Get-Location).Path
          $nodePath = (Get-Command node).Source

          # Create task action to run node server.js directly
          $taskAction = New-ScheduledTaskAction -Execute $nodePath -Argument "server.js --max-old-space-size=2048" -WorkingDirectory $workingDir

          # Trigger: start immediately and on boot
          $triggerNow = New-ScheduledTaskTrigger -Once -At (Get-Date).AddSeconds(5)
          $triggerBoot = New-ScheduledTaskTrigger -AtStartup

          # Settings: keep running, restart on failure
          $taskSettings = New-ScheduledTaskSettingsSet -AllowStartIfOnBatteries -DontStopIfGoingOnBatteries -StartWhenAvailable -RestartOnFailure -RestartCount 3 -RestartInterval (New-TimeSpan -Minutes 1)

          # Register the task
          Register-ScheduledTask -TaskName $taskName -Action $taskAction -Trigger $triggerNow,$triggerBoot -Settings $taskSettings -User $env:USERNAME -RunLevel Highest -Force

          # Start it now
          Start-ScheduledTask -TaskName $taskName
          Start-Sleep -Seconds 3

          Write-Host "‚úÖ Countdown app started via Task Scheduler"
          Write-Host "üìã Task will auto-start on boot and restart on failure"
        shell: powershell

      - name: Show app status
        run: |
          Write-Host "=== Task Scheduler Status ==="
          Get-ScheduledTask -TaskName "CountdownApp" | Select-Object TaskName,State,LastRunTime

          Write-Host "`n=== Node Processes ==="
          Get-Process -Name "node" -ErrorAction SilentlyContinue | Select-Object Id,ProcessName,StartTime

          Write-Host "`n=== Server Status ==="
          try {
            $response = Invoke-WebRequest -Uri "http://localhost:3001/health" -UseBasicParsing -TimeoutSec 5
            Write-Host "‚úÖ Server is running - HTTP $($response.StatusCode)"
          } catch {
            Write-Host "‚ùå Server not yet ready: $_"
          }
        shell: powershell

      - name: Show runner context info
        run: |
          Write-Host "Current user: $env:USERNAME"
          Write-Host "User domain: $env:USERDOMAIN"
          Write-Host "User profile: $env:USERPROFILE"
          Write-Host "Node version: $(node --version)"
          Write-Host "NPM prefix: $(npm config get prefix)"
        shell: powershell
