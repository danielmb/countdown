name: Deploy to Self-Hosted Windows

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Stop existing countdown app
        run: |
          # Stop existing scheduled task
          Stop-ScheduledTask -TaskName "CountdownApp" -ErrorAction SilentlyContinue
          Unregister-ScheduledTask -TaskName "CountdownApp" -Confirm:$false -ErrorAction SilentlyContinue

          # Kill ALL node processes to release file locks
          Get-Process -Name "node" -ErrorAction SilentlyContinue | Stop-Process -Force -ErrorAction SilentlyContinue

          # Wait a moment for processes to fully terminate
          Start-Sleep -Seconds 2

          Write-Host "Stopped existing countdown app processes"
        shell: powershell
        continue-on-error: true

      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "24"
          cache: "npm"

      - name: Install dependencies
        run: npm ci --legacy-peer-deps
        shell: powershell

      - name: Build application
        run: npm run build
        shell: powershell

      - name: Start countdown app via Task Scheduler
        run: |
          $taskName = "CountdownApp"
          $workingDir = (Get-Location).Path
          $nodePath = (Get-Command node).Source

          # Create task action to run node server.js directly
          $taskAction = New-ScheduledTaskAction -Execute $nodePath -Argument "--max-old-space-size=2048 server.js" -WorkingDirectory $workingDir

          # Trigger: start immediately and on boot
          $triggerNow = New-ScheduledTaskTrigger -Once -At (Get-Date).AddSeconds(5)
          $triggerBoot = New-ScheduledTaskTrigger -AtStartup

          # Settings: keep running, allow manual start
          $taskSettings = New-ScheduledTaskSettingsSet -AllowStartIfOnBatteries -DontStopIfGoingOnBatteries -StartWhenAvailable -ExecutionTimeLimit (New-TimeSpan -Days 365)

          # Run task as SYSTEM to avoid credential prompts and keep it alive across reboots
          $principal = New-ScheduledTaskPrincipal -UserId "SYSTEM" -LogonType ServiceAccount -RunLevel Highest

          # Register the task
          Register-ScheduledTask -TaskName $taskName -Action $taskAction -Trigger $triggerNow,$triggerBoot -Settings $taskSettings -Principal $principal -Force

          # Start it now
          Start-ScheduledTask -TaskName $taskName
          Start-Sleep -Seconds 3

          Write-Host "[SUCCESS] Countdown app started via Task Scheduler"
          Write-Host "[INFO] Task runs under SYSTEM and will auto-start on boot"
        shell: powershell

      - name: Show app status
        run: |
          Write-Host "=== Task Scheduler Status ==="
          try {
            Get-ScheduledTask -TaskName "CountdownApp" | Select-Object TaskName,State,LastRunTime
          } catch {
            Write-Host "[WARN] Scheduled task 'CountdownApp' not found: $_"
          }

          Write-Host "`n=== Node Processes ==="
          Get-Process -Name "node" -ErrorAction SilentlyContinue | Select-Object Id,ProcessName,StartTime

          Write-Host "`n=== Server Status ==="
          try {
            $response = Invoke-WebRequest -Uri "http://localhost:3001/health" -UseBasicParsing -TimeoutSec 5
            Write-Host "[SUCCESS] Server is running - HTTP $($response.StatusCode)"
          } catch {
            Write-Host "[ERROR] Server not yet ready: $_"
          }
        shell: powershell

      - name: Show runner context info
        run: |
          Write-Host "Current user: $env:USERNAME"
          Write-Host "User domain: $env:USERDOMAIN"
          Write-Host "User profile: $env:USERPROFILE"
          Write-Host "Node version: $(node --version)"
          Write-Host "NPM prefix: $(npm config get prefix)"
        shell: powershell
